image: docker:18

services:
  - docker:18.09-dind

variables:
  BUILD_DIR: /opt/switcher

stages:
  - deps
  - test
  - coverage
  - deploy

#
# Build dependencies images
#
Build and Deploy dependency images:
  stage: deps
  image: docker:18-git
  variables:
    CONTAINER_TAG_PREFIX: $CI_REGISTRY/sat-metalab/switcher:deps
  script:
    - git clone --single-branch --branch develop https://gitlab.com/sat-metalab/switcher.git switcher-dev
    - mkdir -p switcher-dev/deps
    - "if [ 0 -eq $(diff switcher-dev/deps/ deps/ | wc -l) ]; then echo new image build not required; exit 0; fi"
    - docker build -t $CONTAINER_TAG_PREFIX-ubuntu1804 -f dockerfiles/Dockerfile-deps-Ubuntu-18.04 --target build .
    - echo $CI_DEPLOY_PASSWORD | docker login -u $CI_DEPLOY_USER --password-stdin $CI_REGISTRY
    - docker push $CONTAINER_TAG_PREFIX-ubuntu1804
    - docker build -t $CONTAINER_TAG_PREFIX-ubuntu2004 -f dockerfiles/Dockerfile-deps-Ubuntu-20.04 --target build .
    - docker push $CONTAINER_TAG_PREFIX-ubuntu2004
  except:
    - develop
    - master
    - test-switcher-image

#
# Test distributions
#
Test Ubuntu 18.04:
  stage: test
  image: $CI_REGISTRY/sat-metalab/switcher:deps-ubuntu1804
  variables:
    CTEST_OUTPUT_ON_FAILURE: 1
  script:
    - git submodule update --init --recursive
    - mkdir -p build && cd build 
    - CC="gcc-8" CXX="g++-8" cmake -DENABLE_GPL="ON" -DCMAKE_BUILD_TYPE="Release" ..
    - make -j"$(nproc)" && make install && ldconfig
    - DEBIAN_FRONTEND=noninteractive apt update -y && apt install -y xvfb
    - xvfb-run --auto-servernum --server-args='-screen 0 1920x1080x24' make test
  except:
    - develop
    - master
    - test-switcher-image

Test Ubuntu 20.04:
  stage: test
  image: $CI_REGISTRY/sat-metalab/switcher:deps-ubuntu2004
  variables:
    CTEST_OUTPUT_ON_FAILURE: 1
  script:
    - git submodule update --init --recursive
    - mkdir -p build && cd build 
    - cmake -DENABLE_GPL="ON" -DCMAKE_BUILD_TYPE="Release" ..
    - make -j"$(nproc)" && make install && ldconfig
    - DEBIAN_FRONTEND=noninteractive apt update -y && apt install -y xvfb
    - xvfb-run  --auto-servernum --server-args='-screen 0 1920x1080x24'  pulseaudio &
    - xvfb-run --auto-servernum --server-args='-screen 0 1920x1080x24' make test
  except:
    - develop
    - master
    - test-switcher-image

#
# Test package
#
Test package:
  stage: test
  image: $CI_REGISTRY/sat-metalab/switcher:deps-ubuntu2004
  variables:
    CTEST_OUTPUT_ON_FAILURE: 1
  script:
    - git submodule update --init --recursive
    - mkdir -p build && cd build 
    - cmake -DENABLE_GPL="ON" -DCMAKE_BUILD_TYPE="Release" ..
    - DEBIAN_FRONTEND=noninteractive apt update -y && apt install -y xvfb
    - xvfb-run --auto-servernum --server-args='-screen 0 1920x1080x24' make package_source_test
  only:
    - develop

#
# Test coverage
#
coverage:
  stage: coverage
  image: $CI_REGISTRY/sat-metalab/switcher:deps-ubuntu2004
  script:
    - DEBIAN_FRONTEND=noninteractive apt update -y && apt install -y lcov zip xvfb
    - git submodule update --init --recursive
    - rm -rf build && mkdir build && cd build
    - cmake -DTEST_COVERAGE=ON -DENABLE_GPL=ON ..
    - make -j$(nproc) && make install && ldconfig
    - xvfb-run --auto-servernum --server-args='-screen 0 1920x1080x24'  pulseaudio &
    - xvfb-run --auto-servernum --server-args='-screen 0 1920x1080x24' make check_coverage
    - zip -r coverage.zip coverage
    - mv coverage.zip ../
  artifacts:
    name: "switcher_coverage_${CI_BUILD_REF_NAME}"
    paths:
    - "coverage.zip"
  only:
    - develop

#
# Docker image for Scenic CI
#
Build and Deploy Ubuntu for Scenic:
  stage: deploy
  image: docker:18
  variables:
    CONTAINER_TAG: $CI_REGISTRY/sat-metalab/switcher:$CI_COMMIT_REF_NAME
  script:
    - docker build -t $CONTAINER_TAG --build-arg SWITCHER_TAG=$CI_COMMIT_REF_NAME -f dockerfiles/Dockerfile-Ubuntu-18.04 --target build .
    - echo $CI_DEPLOY_PASSWORD | docker login -u $CI_DEPLOY_USER --password-stdin $CI_REGISTRY
    - docker push $CONTAINER_TAG
  only:
    - develop
    - master
    - test-switcher-image

#
# Package
#
Debian Package Ubuntu 20.04:
  stage: deploy
  image: $CI_REGISTRY/sat-metalab/switcher:deps-ubuntu2004
  script: 
    - DEBIAN_FRONTEND=noninteractive apt update -y
    - git submodule update --init --recursive
    - rm -rf build && mkdir build && cd build
    - cmake -DENABLE_GPL=ON -DCMAKE_INSTALL_PREFIX=/usr ..
    - make -j$(nproc) package
    - mv *.deb ../switcher_ubuntu20.04_latest_amd64.deb
  artifacts:
    name: "switcher_package_${CI_BUILD_REF_NAME}"
    paths:
    - switcher_ubuntu20.04_latest_amd64.deb
  only:
    - master
